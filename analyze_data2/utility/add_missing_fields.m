


% Fix missing files
% Add missing fields to structures as needed

%% Setup vars
sfc_mode=22.401310;
curr_stage=3;
field_to_add = 'lfp_pairs22';

%% First, get list of files to fix

[~, mode_subgroups] = decode_sfc_mode(sfc_mode);
[fname_suffix] = build_sfcmode(sfc_mode, mode_subgroups);
outpath = fullfile(getpath('path_buffer_curr'),['test2mode_' num2str(sfc_mode,12) fname_suffix],['stage_' num2str(curr_stage)]);


fn = dir(fullfile(outpath,'*.mat'));
fn = {fn.name};


%%
for f = 1:length(fn)
    
    clear sfc
    load(fullfile(outpath,fn{f}));
    changes_made=0;
    for i = 1:length(sfc)
    %for i = 1
        if ~isfield(sfc{i},field_to_add)
            fprintf(['Field ' field_to_add ' is missing from file # ' num2str(f) ',' fn{f} ', condition j=' num2str(i) '\n']);
            
            %sz = size(sfc{i}.Cave);
            %sz = size(sfc{i}.Cavep1);
            
            %sfc{j}.(field_to_add) = zeros(sz);
%             sfc{i}.('Cerr1') = zeros(sz);
%             sfc{i}.('Cerr2') = 2*sfc{i}.Cave;
%             sfc{1}.('Ntraces') = 1696*ones(1,sz(2));
%             sfc{1}.('Ntraces2') = 1696*ones(1,sz(2));

%             lfp_names_single = sfc{1}.unit_names;
% 
%             Nelects = length(sfc{1}.unit_names);
%             [lfp1,lfp2] = meshgrid(1:Nelects,1:Nelects);
%             lfp1 = tril(lfp1,-1);
%             lfp2 = tril(lfp2,-1);
%             lfp_pairs = [lfp1(:) lfp2(:)];
%             lfp_pairs = lfp_pairs(lfp1 ~= 0,:);
%             Npairs = size(lfp_pairs,1);
%             clear lfp1 lfp2
% 
%             clear lfp_pairs_names
%             for kk = 1:Npairs
%                 lfp_pairs_names{kk} = [lfp_names_single{lfp_pairs(kk,1)} ':' lfp_names_single{lfp_pairs(kk,2)}];
%             end

%             sfc{1}.lfp_names_single = lfp_names_single;
%             sfc{1}.lfp_pairs = sfc{1}.lfp_pairs';
%             sfc{1}.unit_names = lfp_pairs_names;
            
%             sfc{1}.lfp_names_single = [];
%             sfc{1}.lfp_pairs = [];

            sfc{1}.f = [0,0.976562500000000,1.95312500000000,2.92968750000000,3.90625000000000,4.88281250000000,5.85937500000000,6.83593750000000,7.81250000000000,8.78906250000000,9.76562500000000,10.7421875000000,11.7187500000000,12.6953125000000,13.6718750000000,14.6484375000000,15.6250000000000,16.6015625000000,17.5781250000000,18.5546875000000,19.5312500000000,20.5078125000000,21.4843750000000,22.4609375000000,23.4375000000000,24.4140625000000,25.3906250000000,26.3671875000000,27.3437500000000,28.3203125000000,29.2968750000000,30.2734375000000,31.2500000000000,32.2265625000000,33.2031250000000,34.1796875000000,35.1562500000000,36.1328125000000,37.1093750000000,38.0859375000000,39.0625000000000,40.0390625000000,41.0156250000000,41.9921875000000,42.9687500000000,43.9453125000000,44.9218750000000,45.8984375000000,46.8750000000000,47.8515625000000,48.8281250000000,49.8046875000000,50.7812500000000,51.7578125000000,52.7343750000000,53.7109375000000,54.6875000000000,55.6640625000000,56.6406250000000,57.6171875000000,58.5937500000000,59.5703125000000,60.5468750000000,61.5234375000000,62.5000000000000,63.4765625000000,64.4531250000000,65.4296875000000,66.4062500000000,67.3828125000000,68.3593750000000,69.3359375000000,70.3125000000000,71.2890625000000,72.2656250000000,73.2421875000000,74.2187500000000,75.1953125000000,76.1718750000000,77.1484375000000,78.1250000000000,79.1015625000000,80.0781250000000,81.0546875000000,82.0312500000000,83.0078125000000,83.9843750000000,84.9609375000000,85.9375000000000,86.9140625000000,87.8906250000000,88.8671875000000,89.8437500000000,90.8203125000000,91.7968750000000,92.7734375000000,93.7500000000000,94.7265625000000,95.7031250000000,96.6796875000000,97.6562500000000,98.6328125000000,99.6093750000000,100.585937500000,101.562500000000,102.539062500000,103.515625000000,104.492187500000,105.468750000000,106.445312500000,107.421875000000,108.398437500000,109.375000000000,110.351562500000,111.328125000000,112.304687500000,113.281250000000,114.257812500000,115.234375000000,116.210937500000,117.187500000000,118.164062500000,119.140625000000,120.117187500000,121.093750000000,122.070312500000,123.046875000000,124.023437500000,125,125.976562500000,126.953125000000,127.929687500000,128.906250000000,129.882812500000,130.859375000000,131.835937500000,132.812500000000,133.789062500000,134.765625000000,135.742187500000,136.718750000000,137.695312500000,138.671875000000,139.648437500000,140.625000000000,141.601562500000,142.578125000000,143.554687500000,144.531250000000,145.507812500000,146.484375000000,147.460937500000,148.437500000000,149.414062500000,150.390625000000,151.367187500000,152.343750000000,153.320312500000,154.296875000000,155.273437500000,156.250000000000,157.226562500000,158.203125000000,159.179687500000,160.156250000000,161.132812500000,162.109375000000,163.085937500000,164.062500000000,165.039062500000,166.015625000000,166.992187500000,167.968750000000,168.945312500000,169.921875000000,170.898437500000,171.875000000000,172.851562500000,173.828125000000,174.804687500000,175.781250000000,176.757812500000,177.734375000000,178.710937500000,179.687500000000,180.664062500000,181.640625000000,182.617187500000,183.593750000000,184.570312500000,185.546875000000,186.523437500000,187.500000000000,188.476562500000,189.453125000000,190.429687500000,191.406250000000,192.382812500000,193.359375000000,194.335937500000,195.312500000000,196.289062500000,197.265625000000,198.242187500000,199.218750000000,200.195312500000,201.171875000000,202.148437500000,203.125000000000,204.101562500000,205.078125000000,206.054687500000,207.031250000000,208.007812500000,208.984375000000,209.960937500000,210.937500000000,211.914062500000,212.890625000000,213.867187500000,214.843750000000,215.820312500000,216.796875000000,217.773437500000,218.750000000000,219.726562500000,220.703125000000,221.679687500000,222.656250000000,223.632812500000,224.609375000000,225.585937500000,226.562500000000,227.539062500000,228.515625000000,229.492187500000,230.468750000000,231.445312500000,232.421875000000,233.398437500000,234.375000000000,235.351562500000,236.328125000000,237.304687500000,238.281250000000,239.257812500000,240.234375000000,241.210937500000,242.187500000000,243.164062500000,244.140625000000,245.117187500000,246.093750000000,247.070312500000,248.046875000000,249.023437500000,250,250.976562500000,251.953125000000,252.929687500000,253.906250000000,254.882812500000,255.859375000000,256.835937500000,257.812500000000,258.789062500000,259.765625000000,260.742187500000,261.718750000000,262.695312500000,263.671875000000,264.648437500000,265.625000000000,266.601562500000,267.578125000000,268.554687500000,269.531250000000,270.507812500000,271.484375000000,272.460937500000,273.437500000000,274.414062500000,275.390625000000,276.367187500000,277.343750000000,278.320312500000,279.296875000000,280.273437500000,281.250000000000,282.226562500000,283.203125000000,284.179687500000,285.156250000000,286.132812500000,287.109375000000,288.085937500000,289.062500000000,290.039062500000,291.015625000000,291.992187500000,292.968750000000,293.945312500000,294.921875000000,295.898437500000,296.875000000000,297.851562500000,298.828125000000,299.804687500000,300.781250000000,301.757812500000,302.734375000000,303.710937500000,304.687500000000,305.664062500000,306.640625000000,307.617187500000,308.593750000000,309.570312500000,310.546875000000,311.523437500000,312.500000000000,313.476562500000,314.453125000000,315.429687500000,316.406250000000,317.382812500000,318.359375000000,319.335937500000,320.312500000000,321.289062500000,322.265625000000,323.242187500000,324.218750000000,325.195312500000,326.171875000000,327.148437500000,328.125000000000,329.101562500000,330.078125000000,331.054687500000,332.031250000000,333.007812500000,333.984375000000,334.960937500000,335.937500000000,336.914062500000,337.890625000000,338.867187500000,339.843750000000,340.820312500000,341.796875000000,342.773437500000,343.750000000000,344.726562500000,345.703125000000,346.679687500000,347.656250000000,348.632812500000,349.609375000000,350.585937500000,351.562500000000,352.539062500000,353.515625000000,354.492187500000,355.468750000000,356.445312500000,357.421875000000,358.398437500000,359.375000000000,360.351562500000,361.328125000000,362.304687500000,363.281250000000,364.257812500000,365.234375000000,366.210937500000,367.187500000000,368.164062500000,369.140625000000,370.117187500000,371.093750000000,372.070312500000,373.046875000000,374.023437500000,375,375.976562500000,376.953125000000,377.929687500000,378.906250000000,379.882812500000,380.859375000000,381.835937500000,382.812500000000,383.789062500000,384.765625000000,385.742187500000,386.718750000000,387.695312500000,388.671875000000,389.648437500000,390.625000000000,391.601562500000,392.578125000000,393.554687500000,394.531250000000,395.507812500000,396.484375000000,397.460937500000,398.437500000000,399.414062500000,400.390625000000,401.367187500000,402.343750000000,403.320312500000,404.296875000000,405.273437500000,406.250000000000,407.226562500000,408.203125000000,409.179687500000,410.156250000000,411.132812500000,412.109375000000,413.085937500000,414.062500000000,415.039062500000,416.015625000000,416.992187500000,417.968750000000,418.945312500000,419.921875000000,420.898437500000,421.875000000000,422.851562500000,423.828125000000,424.804687500000,425.781250000000,426.757812500000,427.734375000000,428.710937500000,429.687500000000,430.664062500000,431.640625000000,432.617187500000,433.593750000000,434.570312500000,435.546875000000,436.523437500000,437.500000000000,438.476562500000,439.453125000000,440.429687500000,441.406250000000,442.382812500000,443.359375000000,444.335937500000,445.312500000000,446.289062500000,447.265625000000,448.242187500000,449.218750000000,450.195312500000,451.171875000000,452.148437500000,453.125000000000,454.101562500000,455.078125000000,456.054687500000,457.031250000000,458.007812500000,458.984375000000,459.960937500000,460.937500000000,461.914062500000,462.890625000000,463.867187500000,464.843750000000,465.820312500000,466.796875000000,467.773437500000,468.750000000000,469.726562500000,470.703125000000,471.679687500000,472.656250000000,473.632812500000,474.609375000000,475.585937500000,476.562500000000,477.539062500000,478.515625000000,479.492187500000,480.468750000000,481.445312500000,482.421875000000,483.398437500000,484.375000000000,485.351562500000,486.328125000000,487.304687500000,488.281250000000,489.257812500000,490.234375000000,491.210937500000,492.187500000000,493.164062500000,494.140625000000,495.117187500000,496.093750000000,497.070312500000,498.046875000000,499.023437500000,500];
            %sfc{1}.singletonfieldnames={'bad_data'}
            sfc{1}.F={'bad_data'}
            sfc{1}.F2={'bad_data'}
            sfc{1}.T={'bad_data'}
            sfc{1}.unit_names={'bad_data'}
            sfc{1}.filename={'bad_data'}
            sfc{1}.tapers={'bad_data'}
            sfc{1}.sum_ctgsetli={'bad_data'}
            sfc{1}.include_switch_trials={'bad_data'}
            sfc{1}.N_ctgs_base={'bad_data'}
            sfc{1}.N_ctgs_extras={'bad_data'}
            sfc{1}.Nwind={'bad_data'}
            sfc{1}.md_lfp_names={'bad_data'}
            sfc{1}.md_unit_names={'bad_data'}
            sfc{1}.spikethresh={'bad_data'}
            sfc{1}.StarRate={'bad_data'}
            sfc{1}.params={'bad_data'}
            sfc{1}.i0={'bad_data'}
            sfc{1}.j0={'bad_data'}
              
            changes_made=1;
        end
    end
    
    if changes_made
        save(fullfile(outpath,fn{f}),'sfc');
    end
    
end
%%

    



